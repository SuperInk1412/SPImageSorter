<!DOCTYPE html>
<html lang="zh-CN" style="--tag-columns: 2; --primary-color: hsl(350, 100%, 75%); --primary-dark: hsl(350, 100%, 65%); --primary-light: hsl(350, 100%, 90%); --bg-color: hsl(350, 100%, 97%); --panel-bg: hsl(350, 100%, 95%); --border-color: hsl(350, 100%, 85%); --panel-width: 350px;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹å›¾</title>
    <style>
        :root {
            --primary-color: #ffaeba;
            --primary-dark: #ff91a4;
            --primary-light: #ffdde1;
            --bg-color: #fff5f7;
            --panel-bg: #ffeef2;
            --text-color: #333333;
            --border-color: #ffccd5;
            --panel-width: 350px;
            --tag-columns: 2;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: auto !important;
        }
        .main-container {
            display: flex;
            height: 100%;
        }
        .preview-section {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }
        .control-section {
            width: var(--panel-width);
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            height: 100%;
           /* overflow-y: auto; */
            box-sizing: border-box;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .control-content {
        flex: 1;
        overflow-y: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-menu {
            position: relative;
        }
        .settings-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .settings-btn:hover {
            background-color: var(--primary-dark);
        }
        .settings-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            width: 290px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .settings-dropdown.show {
            display: block;
        }
        .panel-section {
            margin-bottom: 15px;
            padding: 15px;
            border-bottom: 1px dashed var(--border-color);
        }
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: var(--primary-dark);
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .search-container {
            position: relative;
            margin-bottom: 10px;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: white;
        }
        .tag-selector {
            width: 100%;
            min-height: 120px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 10px;
            
            /* å“åº”å¼ç½‘æ ¼ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 5px;
            
            overflow-y: auto;
            max-height: 300px;
            background-color: white;
        }
        .tag-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 3px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        .tag-item:hover {
            background-color: var(--primary-light);
        }
        .tag-item input[type="checkbox"] {
            margin-right: 6px;
            accent-color: var(--primary-color);
        }
        .tag-item label {
            cursor: pointer;
            font-size: 13px;
            flex-grow: 1;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .slider-container input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
            accent-color: var(--primary-color);
        }
        .stats {
            font-size: 14px;
            color: var(--text-color);
            margin-top: 10px;
        }
        .logic-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .logic-btn {
            background-color: var(--primary-color);
            font-size: 12px;
            padding: 4px 8px;
        }
        .logic-btn.active {
            background-color: var(--primary-dark);
        }
        /* æ–°å¢ï¼šå·²é€‰æ ‡ç­¾æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
        .logic-btn.selected-view {
            background-color: var(--primary-dark);
            border: 2px solid var(--primary-color);
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1px;
            background-color: var(--border-color);
            padding: 1px;
            transition: grid-template-columns 0.3s ease;
        }
        .image-card {
            background-color: white;
            position: relative;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            contain: strict; 
            will-change: transform; /* æç¤ºæµè§ˆå™¨ä¼˜åŒ–å˜æ¢ */
        }
        .image-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            position: relative;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        .image-container:hover img {
            transform: scale(1.05);
        }
        .image-tags {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 8px 6px 4px;
            font-size: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: flex-end;
            max-height: 50%;
            overflow: hidden;
        }
        .tag-pill {
            background-color: transparent;
            border: 1px solid rgba(255,255,255,0.7);
            padding: 1px 4px;
            border-radius: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
            color: white;
            cursor: pointer;
        }
        .tag-pill.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-dark);
        }
        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 16px;
            grid-column: 1 / -1;
        }
        .tag-container {
            background: linear-gradient(transparent, rgba(0,0,0,0.3));
            gap: 0.25rem; /* ä½¿ç”¨ç›¸å¯¹å•ä½ */
            padding: 0.25rem;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .logic-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .control-row label {
            min-width: 100px;
            font-size: 12px;
        }
        .control-row input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }
        .control-row .value-display {
            min-width: 30px;
            text-align: center;
        }
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .settings-section {
            margin-bottom: 15px;
        }
        .settings-section:last-child {
            margin-bottom: 0;
        }
        .settings-section-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-color);
        }
        .panel-width-control {
            margin-top: 10px;
        }
        
        /* å›¾ç‰‡åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            font-size: 10px;
            margin-top: 5px;
        }
        
        .error-icon {
            color: #ff6b6b;
            font-size: 24px;
        }
        
        .loading-placeholder {
            all: unset; /* é‡ç½®æ‰€æœ‰æ ·å¼ */
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(255,255,255,0.8);
            font-size: 2em;
        }
        
        .image-status {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            z-index: 2;
        }
        
        .progress-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        
        /* æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .preview-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .preview-content {
            display: flex;
            max-width: 90%;
            max-height: 90%;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            width: 90vw;
            height: 90vh;
            
            /* ç¡®ä¿å­å…ƒç´ ä¸ä¼šæº¢å‡º */
            position: relative;
        }
        
        .preview-image-container {
            position: relative;
            width: 70%; /* å›ºå®šå·¦ä¾§å®½åº¦ */
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: 
                linear-gradient(45deg, #f5f5f5 25%, transparent 25%, transparent 75%, #f5f5f5 75%),
                linear-gradient(45deg, #f5f5f5 25%, transparent 25%, transparent 75%, #f5f5f5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            
            /* ç¡®ä¿å›¾ç‰‡ä¸ä¼šæº¢å‡ºå®¹å™¨ */
            position: relative;
            z-index: 1;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: grab;
            transition: transform 0.2s;
        }
        
        .preview-image.dragging {
            cursor: grabbing;
        }
        
        .preview-info-panel {
            width: 30%;
            padding: 20px;
            background-color: var(--panel-bg);
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-dark);
            font-size: 16px;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: bold;
            min-width: 100px;
            color: var(--text-color);
        }
        
        .info-value {
            flex-grow: 1;
            color: #555;
            word-break: break-all;
        }
        
        .preview-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .preview-tag {
            background-color: var(--primary-light);
            border: 1px solid var(--primary-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .preview-tag:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .preview-tag.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .preview-tag-confidence {
            font-size: 10px;
            color: #666;
            margin-left: 5px;
        }
        
        .preview-actions {
            margin-top: 20px;
        }
        
        .preview-zoom-controls {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .zoom-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .zoom-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .zoom-value {
            font-size: 14px;
        }
        
        .search-image-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
        }
        
        .search-image-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        
        .close-preview-icon {
            color: white;
            font-size: 20px;
        }
        .preview-nav-buttons {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            z-index: 5;
            pointer-events: none;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            pointer-events: auto;
        }

        .nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .nav-btn:disabled {
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;

        }ã€
        /* æ–°å¢ï¼šæ‡’åŠ è½½å ä½ç¬¦æ ·å¼ */
        .lazy-placeholder {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
            /* å“åº”å¼é«˜åº¦ */
            width: 100%;
            aspect-ratio: 4/3; /* 4:3 æ¯”ä¾‹ */
            position: relative;
            overflow: hidden;
        }

        .lazy-placeholder:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 12px;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
            margin-bottom: 5px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ‡’åŠ è½½å›¾ç‰‡çš„è¿‡æ¸¡æ•ˆæœ */
        .image-card:not(.lazy-placeholder) {
            animation: fadeIn 0.1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* æ—¶é—´æ’åºæŒ‰é’®æ ·å¼ */
        #time-sort-btn.active {
            background-color: var(--theme-color, #6495ed);
            color: white;
            box-shadow: 0 0 10px rgba(100, 149, 237, 0.5);
        }
        /* ä¿®æ”¹åçš„æ—¶é—´æ˜¾ç¤ºå®¹å™¨æ ·å¼ */
        .time-display-container {
            position: fixed;
            top: 10px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.98);
            border: 1px solid #1890ff;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.2);
            max-width: 320px;
            word-break: break-all;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none; /* é»˜è®¤éšè— */
            opacity: 0;
            transform: translateY(-10px);
        }

        .time-display-container.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .time-display-label {
            color: #666;
            margin-right: 6px;
            font-size: 12px;
        }

        .time-display-value {
            color: #1890ff;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* å¯é€‰ï¼šæ·»åŠ ä¸€ä¸ªå¾®å¦™çš„æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .time-display-container.visible {
            animation: fadeInSlide 0.3s ease-out;
        }

    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-section">
            <div id="imageGrid" class="image-grid" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));">
                <div class="no-data">æ²¡æœ‰å›¾ç‰‡æ•°æ®ï¼Œè¯·å…ˆåŠ è½½CSVæ–‡ä»¶</div>
            </div>
        </div>
        
        <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="control-section">
            <div class="header">
                <h2>æ§åˆ¶é¢æ¿</h2>
                <div class="settings-menu">
                    <button class="settings-btn">âš™ï¸ è®¾ç½®</button>
                    <div class="settings-dropdown" id="settingsDropdown">
                        <div class="settings-section">
                            <div class="settings-section-title">å¸ƒå±€è®¾ç½®</div>
                            <div class="control-row">
                                <label>æ¯è¡Œå›¾ç‰‡æ•°:</label>
                                <input type="range" id="columnsSlider" min="2" max="12" step="1" value="5">
                                <span id="columnsValue" class="value-display">è‡ªåŠ¨</span>
                            </div>
                            <div class="btn-group" style="margin-top: 5px;">
                                <button id="preset2Btn" class="preset-btn">2åˆ—</button>
                                <button id="preset4Btn" class="preset-btn">4åˆ—</button>
                                <button id="preset6Btn" class="preset-btn">6åˆ—</button>
                                <button id="preset8Btn" class="preset-btn">8åˆ—</button>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">æ ‡ç­¾æ˜¾ç¤º</div>
                            <div class="control-row">
                                <label>æœ€å¤§æ ‡ç­¾æ•°:</label>
                                <input type="range" id="maxTagsSlider" min="0" max="10" step="1" value="3">
                                <span id="maxTagsValue" class="value-display">3</span>
                            </div>
                            <div class="control-row">
                                <label>æ ‡ç­¾åˆ—æ•°:</label>
                                <input type="range" id="tagColumnsSlider" min="1" max="4" step="1" value="2">
                                <span id="tagColumnsValue" class="value-display">2</span>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">é¢œè‰²ä¸»é¢˜</div>
                            <div class="control-row">
                                <label>ä¸»è‰²è°ƒ:</label>
                                <input type="range" id="hueSlider" min="0" max="360" value="350">
                                <div class="color-preview" id="primaryPreview" style="background-color: rgb(255, 179, 191);"></div>
                            </div>
                            <div class="control-row">
                                <label>èƒŒæ™¯è‰²:</label>
                                <input type="range" id="bgHueSlider" min="0" max="360" value="350">
                                <div class="color-preview" id="bgPreview" style="background-color: rgb(255, 240, 242);"></div>
                            </div>
                            <button id="resetColorsBtn" style="width: 100%; margin-top: 5px; font-size: 12px;">é‡ç½®ä¸ºé»˜è®¤ç²‰è‰²</button>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">é¢æ¿è®¾ç½®</div>
                            <div class="control-row">
                                <label>é¢æ¿å®½åº¦:</label>
                                <input type="range" id="panelWidthSlider" min="200" max="600" step="10" value="350">
                                <span id="panelWidthValue" class="value-display">350px</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-content">
                <div class="panel-section">
                    <div class="btn-group">
                        <button id="loadCsvBtn">ğŸ“ åŠ è½½å›¾ç‰‡æ ‡ç­¾CSV</button>
                        <button id="loadTranslationBtn">ğŸŒ å¯¼å…¥å¯¹ç…§ç¿»è¯‘</button>
                        <button id="exportBtn">ğŸ’¾ å¯¼å‡ºç­›é€‰ç»“æœ</button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="section-title">æ ‡ç­¾ç­›é€‰</div>
                    <div class="search-container">
                        <input type="text" id="tagSearchInput" class="search-input" placeholder="æœç´¢æ ‡ç­¾(ä¸­/è‹±)...">
                    </div>
                    <div class="logic-controls">
                        <span>ç­›é€‰é€»è¾‘:</span>
                        <button id="intersectionBtn" class="logic-btn active">äº¤é›† (AND)</button>
                        <button id="unionBtn" class="logic-btn">å¹¶é›† (OR)</button>
                        <!-- æ·»åŠ æ–°æŒ‰é’® -->
                        <button id="showSelectedBtn" class="logic-btn">ğŸ‘ï¸ åªçœ‹å·²é€‰</button>
                    </div>
                    <div id="tagSelector" class="tag-selector">
                        <!-- æ ‡ç­¾å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="logic-info">äº¤é›†æ¨¡å¼ï¼šå›¾ç‰‡å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­æ ‡ç­¾ | å¹¶é›†æ¨¡å¼ï¼šå›¾ç‰‡åŒ…å«ä»»æ„é€‰ä¸­æ ‡ç­¾å³å¯</div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button id="filterBtn">ğŸ” åº”ç”¨ç­›é€‰</button>
                        <button id="clearBtn">âŒ æ¸…é™¤ç­›é€‰</button>
                        <button id="selectAllBtn">âœ… å…¨é€‰æ ‡ç­¾</button>
                        <button id="deselectAllBtn">â å–æ¶ˆå…¨é€‰</button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-title">æ—¶é—´æ’åº</div>
                    <div class="btn-group">
                        <button id="timeSortBtn" class="control-btn">â° æŒ‰æ—¶é—´æ’åº</button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-title">ç½®ä¿¡åº¦ç­›é€‰</div>
                    <div class="slider-container">
                        <label for="confidenceSlider">æœ€å°ç½®ä¿¡åº¦:</label>
                        <input type="range" id="confidenceSlider" min="0" max="1" step="0.01" value="0.5">
                        <span id="confidenceValue">0.50</span>
                    </div>
                </div>
                
                <div id="stats" class="stats">å°±ç»ª - è¯·åŠ è½½å›¾ç‰‡æ ‡ç­¾CSV</div>
                <div id="translationStats" class="translation-info"></div>
            </div>
        </div>
    </div>
    <div class="settings-dropdown" id="settingsDropdown"></div>
    <!-- æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="preview-modal" id="previewModal">
        <div class="close-preview" id="closePreview">
            <span class="close-preview-icon">Ã—</span>
        </div>
        <div class="preview-content">
            <div class="preview-image-container">
                <!-- åœ¨è¿™é‡Œæ·»åŠ å¯¼èˆªæŒ‰é’® -->
                <div class="preview-nav-buttons">
                    <button class="nav-btn prev-btn" id="prevImageBtn">â€¹</button>
                    <button class="nav-btn next-btn" id="nextImageBtn">â€º</button>
                </div>
                <img class="preview-image" id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
            </div>
            <div class="preview-info-panel">
                <div class="info-section">
                    <div class="info-title">å›¾ç‰‡ä¿¡æ¯</div>
                    <div class="info-row">
                        <div class="info-label">åç§°:</div>
                        <div class="info-value" id="imageName">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">å¤§å°:</div>
                        <div class="info-value" id="imageSize">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">åˆ†è¾¨ç‡:</div>
                        <div class="info-value" id="imageResolution">-</div>
                    </div>
                    <!-- æ–°å¢ä¿®æ”¹æ—¥æœŸè¡Œ -->
                    <div class="info-row">
                        <div class="info-label">ä¿®æ”¹æ—¥æœŸ:</div>
                        <div class="info-value" id="imageModifyDate">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">è·¯å¾„:</div>
                        <div class="info-value" id="imagePath">-</div>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="info-title">æ ‡ç­¾</div>
                    <div class="preview-tags" id="previewTags">
                        <!-- æ ‡ç­¾å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="info-title">ç¼©æ”¾æ§åˆ¶</div>
                    <div class="preview-zoom-controls">
                        <button class="zoom-btn" id="zoomOutBtn">-</button>
                        <button class="zoom-btn" id="zoomInBtn">+</button>
                        <span class="zoom-value" id="zoomValue">100%</span>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æç¤º:</div>
                        <div class="info-value">é¼ æ ‡æ‚¬åœæ—¶å¯ç”¨æ»šè½®ç¼©æ”¾</div>
                    </div>
                </div>
                
                <div class="preview-actions">
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let imageData = [];
        let allTags = new Map();
        let filteredImages = [];
        let filterLogic = 'intersection';
        let columnsPerRow = '5';
        let enToZhMap = new Map();
        let zhToEnMap = new Map();
        let maxDisplayedTags = 3;
        let tagColumns = 2;
        let csvFileDirectory = '';
        let imageCache = new Map();
        let loadingQueue = [];
        let maxConcurrentLoads = 5;
        let currentLoads = 0;
        let showSelectedOnly = false; // æ˜¯å¦åªæ˜¾ç¤ºå·²é€‰æ ‡ç­¾
        
        // æ–°å¢ï¼šé¢„è§ˆç›¸å…³å˜é‡
        let currentPreviewImage = null;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;
        let scale = 1;
        let currentPreviewIndex = 0; // å½“å‰é¢„è§ˆå›¾ç‰‡çš„ç´¢å¼•

        // æ–°å¢æ‡’åŠ è½½ç›¸å…³å…¨å±€å˜é‡
        let visibleImageIndices = new Set(); // å½“å‰å¯è§å›¾ç‰‡ç´¢å¼•
        let observer = null; // IntersectionObserverå®ä¾‹
        let loadedImageCount = 0; // å·²åŠ è½½å›¾ç‰‡æ•°é‡
        let maxLoadedImages = 50; // æœ€å¤§åŒæ—¶åŠ è½½å›¾ç‰‡æ•°
        let unloadThreshold = 100; // å¸è½½ä¸å¯è§å›¾ç‰‡çš„é˜ˆå€¼
        
        // DOMå…ƒç´ 
        const settingsBtn = document.querySelector('.settings-btn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const loadCsvBtn = document.getElementById('loadCsvBtn');
        const loadTranslationBtn = document.getElementById('loadTranslationBtn');
        const exportBtn = document.getElementById('exportBtn');
        const tagSearchInput = document.getElementById('tagSearchInput');
        const tagSelector = document.getElementById('tagSelector');
        const intersectionBtn = document.getElementById('intersectionBtn');
        const unionBtn = document.getElementById('unionBtn');
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceValue = document.getElementById('confidenceValue');
        const columnsSlider = document.getElementById('columnsSlider');
        const columnsValue = document.getElementById('columnsValue');
        const preset2Btn = document.getElementById('preset2Btn');
        const preset4Btn = document.getElementById('preset4Btn');
        const preset6Btn = document.getElementById('preset6Btn');
        const preset8Btn = document.getElementById('preset8Btn');
        const maxTagsSlider = document.getElementById('maxTagsSlider');
        const maxTagsValue = document.getElementById('maxTagsValue');
        const tagColumnsSlider = document.getElementById('tagColumnsSlider');
        const tagColumnsValue = document.getElementById('tagColumnsValue');
        const hueSlider = document.getElementById('hueSlider');
        const bgHueSlider = document.getElementById('bgHueSlider');
        const primaryPreview = document.getElementById('primaryPreview');
        const bgPreview = document.getElementById('bgPreview');
        const resetColorsBtn = document.getElementById('resetColorsBtn');
        const panelWidthSlider = document.getElementById('panelWidthSlider');
        const panelWidthValue = document.getElementById('panelWidthValue');
        const filterBtn = document.getElementById('filterBtn');
        const clearBtn = document.getElementById('clearBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const stats = document.getElementById('stats');
        const translationStats = document.getElementById('translationStats');
        const imageGrid = document.getElementById('imageGrid');
        const showSelectedBtn = document.getElementById('showSelectedBtn');
        
        // æ–°å¢ï¼šé¢„è§ˆç›¸å…³DOMå…ƒç´ 
        const previewModal = document.getElementById('previewModal');
        const previewImage = document.getElementById('previewImage');
        const closePreview = document.getElementById('closePreview');
        const imageName = document.getElementById('imageName');
        const imageSize = document.getElementById('imageSize');
        const imageResolution = document.getElementById('imageResolution');
        const imageModifyDate = document.getElementById('imageModifyDate');
        const imagePath = document.getElementById('imagePath');
        const previewTags = document.getElementById('previewTags');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomValue = document.getElementById('zoomValue');
        const searchImageBtn = document.getElementById('searchImageBtn');
        
        // äº‹ä»¶ç›‘å¬å™¨
        settingsBtn.addEventListener('click', toggleSettings);
        loadCsvBtn.addEventListener('click', loadCsv);
        loadTranslationBtn.addEventListener('click', loadTranslationCsv);
        exportBtn.addEventListener('click', exportFilteredResults);
        tagSearchInput.addEventListener('input', filterTags);
        intersectionBtn.addEventListener('click', () => setFilterLogic('intersection'));
        unionBtn.addEventListener('click', () => setFilterLogic('union'));
        confidenceSlider.addEventListener('input', updateConfidenceValue);
        columnsSlider.addEventListener('input', updateColumnsLayout);
        preset2Btn.addEventListener('click', () => setColumnsPreset(2));
        preset4Btn.addEventListener('click', () => setColumnsPreset(4));
        preset6Btn.addEventListener('click', () => setColumnsPreset(6));
        preset8Btn.addEventListener('click', () => setColumnsPreset(8));
        maxTagsSlider.addEventListener('input', updateMaxTags);
        tagColumnsSlider.addEventListener('input', updateTagColumns);
        hueSlider.addEventListener('input', updateColors);
        bgHueSlider.addEventListener('input', updateColors);
        resetColorsBtn.addEventListener('click', resetColors);
        panelWidthSlider.addEventListener('input', updatePanelWidth);
        filterBtn.addEventListener('click', filterImages);
        clearBtn.addEventListener('click', clearFilters);
        selectAllBtn.addEventListener('click', selectAllTags);
        deselectAllBtn.addEventListener('click', deselectAllTags);
        showSelectedBtn.addEventListener('click', toggleSelectedView);
        
        // æ–°å¢ï¼šé¢„è§ˆç›¸å…³äº‹ä»¶ç›‘å¬å™¨
        closePreview.addEventListener('click', closePreviewModal);
        zoomOutBtn.addEventListener('click', () => adjustZoom(-0.1));
        zoomInBtn.addEventListener('click', () => adjustZoom(0.1));

        // æ–°å¢ï¼šé¢„è§ˆå¯¼èˆªæŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('prevImageBtn').addEventListener('click', showPrevImage);
        document.getElementById('nextImageBtn').addEventListener('click', showNextImage);

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', handleKeyboardNavigation);
        
        // åœ¨å›¾ç‰‡å®¹å™¨ä¸Šç›‘å¬ï¼Œè€Œä¸æ˜¯å›¾ç‰‡æœ¬èº«
        const previewImageContainer = document.querySelector('.preview-image-container');

        // å›¾ç‰‡é¢„è§ˆç›¸å…³äº‹ä»¶
        previewImage.addEventListener('mousedown', startDrag);
        previewImage.addEventListener('mousemove', dragImage);
        previewImage.addEventListener('mouseup', endDrag);
        previewImageContainer.addEventListener('mouseleave', (e) => {
           // åªæœ‰åœ¨æ‹–æ‹½ä¸­ä¸”é¼ æ ‡ç¦»å¼€å®¹å™¨æ—¶æ‰ç»“æŸ
           if (isDragging && !isMouseInContainer(e)) {
                endDrag();
            }
        });
        previewImageContainer.addEventListener('wheel', handleWheel);
        // previewImage.addEventListener('wheel', handleWheel);
        previewImage.addEventListener('mouseenter', () => {
            previewImage.style.cursor = 'grab';
        });
        
        // åˆ‡æ¢è®¾ç½®èœå•æ˜¾ç¤º
        function toggleSettings() {
            settingsDropdown.classList.toggle('show');
        }
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è®¾ç½®èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.settings-menu')) {
                settingsDropdown.classList.remove('show');
            }
        });

        // è®¾ç½®ç­›é€‰é€»è¾‘
        function setFilterLogic(logic) {
            filterLogic = logic;
            intersectionBtn.classList.toggle('active', logic === 'intersection');
            unionBtn.classList.toggle('active', logic === 'union');
        }

        // åˆ‡æ¢åªçœ‹å·²é€‰æ ‡ç­¾è§†å›¾
        function toggleSelectedView() {
            showSelectedOnly = !showSelectedOnly;
            
            if (showSelectedOnly) {
                showSelectedBtn.classList.add('selected-view');
                showSelectedBtn.textContent = 'ğŸ‘ï¸ æ˜¾ç¤ºå…¨éƒ¨';
            } else {
                showSelectedBtn.classList.remove('selected-view');
                showSelectedBtn.textContent = 'ğŸ‘ï¸ åªçœ‹å·²é€‰';
            }
            
            // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
            filterTags();
        }

        
        // æ›´æ–°ç½®ä¿¡åº¦æ˜¾ç¤º
        function updateConfidenceValue() {
            confidenceValue.textContent = parseFloat(confidenceSlider.value).toFixed(2);
        }
        
        // æ›´æ–°åˆ—å¸ƒå±€
        function updateColumnsLayout() {
            const sliderValue = parseInt(columnsSlider.value);
            if (sliderValue === 0) {
                columnsPerRow = 'auto';
                columnsValue.textContent = 'è‡ªåŠ¨';
            } else {
                columnsPerRow = sliderValue;
                columnsValue.textContent = sliderValue;
            }
            applyGridLayout();
        }
        
        // æ›´æ–°æ ‡ç­¾åˆ—æ•°
        function updateTagColumns() {
            tagColumns = parseInt(tagColumnsSlider.value);
            tagColumnsValue.textContent = tagColumns;
            
            // åŠ¨æ€æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--tag-columns', tagColumns);
            
            // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
            tagSelector.style.gridTemplateColumns = `repeat(${tagColumns}, minmax(120px, 1fr))`;
        }
                
        // è®¾ç½®é¢„è®¾åˆ—æ•°
        function setColumnsPreset(num) {
            columnsPerRow = num;
            columnsSlider.value = num;
            columnsValue.textContent = num;
            applyGridLayout();
        }
        
        // åº”ç”¨ç½‘æ ¼å¸ƒå±€
        function applyGridLayout() {
            const gridStyle = imageGrid.style;
            if (columnsPerRow === 'auto') {
                gridStyle.gridTemplateColumns = 'repeat(auto-fill, minmax(140px, 1fr))';
            } else {
                gridStyle.gridTemplateColumns = `repeat(${columnsPerRow}, 1fr)`;
            }
        }
        
        // æ›´æ–°æœ€å¤§æ ‡ç­¾æ•°
        function updateMaxTags() {
            maxDisplayedTags = parseInt(maxTagsSlider.value);
            maxTagsValue.textContent = maxDisplayedTags;
            if (filteredImages.length > 0) {
                displayImages();
            }
        }
        
        // æ›´æ–°é¢œè‰²
        function updateColors() {
            const hue = hueSlider.value;
            const bgHue = bgHueSlider.value;
            
            // æ›´æ–°é¢„è§ˆ
            primaryPreview.style.backgroundColor = `hsl(${hue}, 100%, 85%)`;
            bgPreview.style.backgroundColor = `hsl(${bgHue}, 100%, 97%)`;
            
            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--primary-color', `hsl(${hue}, 100%, 75%)`);
            document.documentElement.style.setProperty('--primary-dark', `hsl(${hue}, 100%, 65%)`);
            document.documentElement.style.setProperty('--primary-light', `hsl(${hue}, 100%, 90%)`);
            document.documentElement.style.setProperty('--bg-color', `hsl(${bgHue}, 100%, 97%)`);
            document.documentElement.style.setProperty('--panel-bg', `hsl(${bgHue}, 100%, 95%)`);
            document.documentElement.style.setProperty('--border-color', `hsl(${hue}, 100%, 85%)`);
        }
        
        // æ›´æ–°é¢æ¿å®½åº¦
        function updatePanelWidth() {
            const width = panelWidthSlider.value;
            document.documentElement.style.setProperty('--panel-width', `${width}px`);
            panelWidthValue.textContent = `${width}px`;
            
            // é¢æ¿å®½åº¦å˜åŒ–æ—¶é‡æ–°è®¡ç®—æ ‡ç­¾åˆ—æ•°
            setTimeout(updateTagColumns, 10);
        }
        
        // é‡ç½®é¢œè‰²
        function resetColors() {
            hueSlider.value = 350;
            bgHueSlider.value = 350;
            updateColors();
        }
        
        // åŠ è½½å›¾ç‰‡æ ‡ç­¾CSV
        function loadCsv() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const csvData = event.target.result;
                        // è·å–CSVæ–‡ä»¶æ‰€åœ¨ç›®å½•
                        csvFileDirectory = getFileDirectory(file.name);
                        parseCsvData(csvData, file.name);
                    } catch (error) {
                        alert(`åŠ è½½CSVæ–‡ä»¶å¤±è´¥: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // è·å–æ–‡ä»¶æ‰€åœ¨ç›®å½•
        function getFileDirectory(filePath) {
            // å¦‚æœæ˜¯å®Œæ•´è·¯å¾„ï¼Œæå–ç›®å½•éƒ¨åˆ†
            if (filePath.includes('/')) {
                return filePath.substring(0, filePath.lastIndexOf('/') + 1);
            } else if (filePath.includes('\\')) {
                return filePath.substring(0, filePath.lastIndexOf('\\') + 1);
            }
            // å¦‚æœåªæ˜¯æ–‡ä»¶åï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆå½“å‰ç›®å½•ï¼‰
            return '';
        }
        
        // åŠ è½½å¯¹ç…§ç¿»è¯‘CSV
        function loadTranslationCsv() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const csvData = event.target.result;
                        parseTranslationCsv(csvData);
                    } catch (error) {
                        alert(`åŠ è½½å¯¹ç…§ç¿»è¯‘CSVå¤±è´¥: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // è§£æå¯¹ç…§ç¿»è¯‘CSV
        function parseTranslationCsv(csvString) {
            enToZhMap.clear();
            zhToEnMap.clear();
            const lines = csvString.split('\n');
            let mapCount = 0;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const cols = parseCsvLine(line);
                if (cols.length < 2) continue;
                const enTag = cols[0].trim();
                const zhTag = cols[1].trim();
                if (!enTag) continue;
                enToZhMap.set(enTag, zhTag);
                if (!zhToEnMap.has(zhTag)) zhToEnMap.set(zhTag, new Set());
                zhToEnMap.get(zhTag).add(enTag);
                mapCount++;
            }
            translationStats.textContent = `å·²åŠ è½½ ${mapCount} æ¡ä¸­è‹±æ–‡æ ‡ç­¾æ˜ å°„`;
            if (imageData.length > 0) {
                updateTagSelector();
                displayImages();
            }
        }
        
        // è§£æCSVè¡Œ
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        // è§£æå›¾ç‰‡æ ‡ç­¾CSVæ•°æ® - ä¿®æ”¹ä¸ºå¤„ç†ç›¸å¯¹è·¯å¾„
        function parseCsvData(csvString, filename) {
            imageData = [];
            allTags.clear();
            imageCache.clear(); // æ¸…ç©ºå›¾ç‰‡ç¼“å­˜
            loadingQueue = []; // æ¸…ç©ºåŠ è½½é˜Ÿåˆ—
            currentLoads = 0; // é‡ç½®å½“å‰åŠ è½½æ•°
            
            const lines = csvString.split('\n');
            
            // è§£æè¡¨å¤´ï¼ŒæŸ¥æ‰¾åˆ—ç´¢å¼•
            let headerRow = [];
            let modifyDateIndex = -1;
            
            if (lines.length > 0) {
                const firstLine = lines[0].trim();
                if (firstLine) {
                    headerRow = parseCsvLine(firstLine);
                    
                    // æŸ¥æ‰¾"ä¿®æ”¹æ—¥æœŸ"åˆ—çš„ç´¢å¼•
                    // æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„åˆ—åå˜ä½“ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€å¤§å°å†™ï¼‰
                    for (let i = 0; i < headerRow.length; i++) {
                        const columnName = headerRow[i].trim().toLowerCase();
                        if (columnName.includes('ä¿®æ”¹æ—¥æœŸ') || 
                            columnName.includes('modify') || 
                            columnName.includes('date') ||
                            columnName.includes('updated')) {
                            modifyDateIndex = i;
                            break;
                        }
                    }
                }
            }
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const row = parseCsvLine(line);
                if (row.length < 2) continue;
                
                let imagePath = row[0].trim();
                
                // å¤„ç†ç›¸å¯¹è·¯å¾„ï¼šå¦‚æœè·¯å¾„ä¸æ˜¯ä»¥http://æˆ–https://å¼€å¤´ï¼Œåˆ™è®¤ä¸ºæ˜¯ç›¸å¯¹è·¯å¾„
                if (!imagePath.startsWith('http://') && !imagePath.startsWith('https://')) {
                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç»“åˆCSVæ–‡ä»¶æ‰€åœ¨ç›®å½•ç”Ÿæˆå®Œæ•´è·¯å¾„
                    if (csvFileDirectory && !imagePath.startsWith('/') && !imagePath.match(/^[a-zA-Z]:/)) {
                        imagePath = csvFileDirectory + imagePath;
                    }
                }
                
                const { tags, confidences } = parseTagsAndConfidences(row);
                if (tags.length === 0) continue;
                
                // è§£æä¿®æ”¹æ—¥æœŸ
                let modifyDate = null;
                if (modifyDateIndex !== -1 && row.length > modifyDateIndex) {
                    const dateString = row[modifyDateIndex].trim();
                    if (dateString) {
                        // å°è¯•è§£ææ—¥æœŸå­—ç¬¦ä¸²
                        // æ”¯æŒå¤šç§æ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS, YYYY/MM/DD HH:MM:SS, ç­‰
                        const parsedDate = parseDateString(dateString);
                        if (parsedDate && !isNaN(parsedDate.getTime())) {
                            modifyDate = parsedDate;
                        }
                    }
                }
                
                imageData.push({ 
                    path: imagePath, 
                    tags, 
                    confidences, 
                    rowNumber: i + 1, 
                    originalData: row,
                    modifyDate: modifyDate  // æ–°å¢å­—æ®µ
                });
                
                tags.forEach(tag => {
                    allTags.set(tag, (allTags.get(tag) || 0) + 1);
                });
            }
            
            updateTagSelector();
            filteredImages = [...imageData];
            displayImages();
            updateStats();
            alert(`æˆåŠŸåŠ è½½ ${imageData.length} å¼ å›¾ç‰‡ï¼Œå…± ${allTags.size} ä¸ªæ ‡ç­¾`);
        }

        // æ–°å¢è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¥æœŸå­—ç¬¦ä¸²
        function parseDateString(dateString) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å¼•å·
            const cleanDateString = dateString.replace(/['"]/g, '').trim();
            
            // å°è¯•å¤šç§æ—¥æœŸæ ¼å¼
            const dateFormats = [
                // YYYY-MM-DD HH:MM:SS
                /^(\d{4})-(\d{1,2})-(\d{1,2})[T\s](\d{1,2}):(\d{1,2}):(\d{1,2})/,
                // YYYY/MM/DD HH:MM:SS
                /^(\d{4})\/(\d{1,2})\/(\d{1,2})[T\s](\d{1,2}):(\d{1,2}):(\d{1,2})/,
                // YYYY-MM-DD
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
                // YYYY/MM/DD
                /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/,
                // æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
                /^\d{13}$/,
                // æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
                /^\d{10}$/
            ];
            
            for (const format of dateFormats) {
                const match = cleanDateString.match(format);
                if (match) {
                    if (format.source.includes('\\d{13}')) {
                        // æ¯«ç§’æ—¶é—´æˆ³
                        return new Date(parseInt(cleanDateString));
                    } else if (format.source.includes('\\d{10}')) {
                        // ç§’æ—¶é—´æˆ³
                        return new Date(parseInt(cleanDateString) * 1000);
                    } else if (match[4] !== undefined) {
                        // åŒ…å«æ—¶é—´çš„æ ¼å¼
                        const [year, month, day, hour, minute, second] = match.slice(1, 7).map(Number);
                        return new Date(year, month - 1, day, hour || 0, minute || 0, second || 0);
                    } else {
                        // åªåŒ…å«æ—¥æœŸçš„æ ¼å¼
                        const [year, month, day] = match.slice(1, 4).map(Number);
                        return new Date(year, month - 1, day);
                    }
                }
            }
            
            // å¦‚æœä»¥ä¸Šéƒ½ä¸åŒ¹é…ï¼Œå°è¯•ä½¿ç”¨JavaScriptå†…ç½®çš„Dateè§£æ
            const date = new Date(cleanDateString);
            return !isNaN(date.getTime()) ? date : null;
        }   

        let originalSortOrder = []; // ä¿å­˜åŸå§‹é¡ºåº

    
        // è§£ææ ‡ç­¾å’Œç½®ä¿¡åº¦
        function parseTagsAndConfidences(row) {
            let tags = [];
            let confidences = [];
            try {
                // æƒ…å†µ1ï¼šæœ‰å¸¦ç½®ä¿¡åº¦çš„æ ‡ç­¾æ ¼å¼ï¼ˆç¬¬4åˆ—ï¼‰
                if (row.length >= 4 && row[3].includes('(') && row[3].includes(')')) {
                    const tagConfPairs = row[3].split(', ');
                    for (const pair of tagConfPairs) {
                        if (pair.includes('(') && pair.includes(')')) {
                            const bracketIndex = pair.lastIndexOf('(');
                            const tag = pair.substring(0, bracketIndex).trim();
                            const confStr = pair.substring(bracketIndex + 1, pair.indexOf(')'));
                            const conf = parseFloat(confStr);

                            tags.push(tag);
                            // åªæœ‰å½“parseFloatè¿”å›æœ‰æ•ˆæ•°å­—æ—¶æ‰ä½¿ç”¨ï¼Œå¦åˆ™ç”¨1.0
                            confidences.push(isNaN(conf) ? 1.0 : conf);
                        }
                    }
                } 
                else if (row.length >= 5) {
                    tags = row[2].includes(',') ? row[2].split(',').map(t => t.trim()) : [row[2].trim()];
                    const confCol = row[3].trim();
                    confidences = confCol.includes(',') ? confCol.split(',').map(c => parseFloat(c.trim()) || 0) : [parseFloat(confCol) || 0];
                    if (tags.length > confidences.length) {
                        confidences = confidences.concat(Array(tags.length - confidences.length).fill(1.0));
                    } else if (confidences.length > tags.length) {
                        confidences = confidences.slice(0, tags.length);
                    }
                } else if (row.length >= 3) {
                    tags = row[2].includes(',') ? row[2].split(',').map(t => t.trim()) : [row[2].trim()];
                    confidences = Array(tags.length).fill(1.0);
                }
            } catch (e) {
                console.error('è§£ææ ‡ç­¾å’Œç½®ä¿¡åº¦æ—¶å‡ºé”™:', e);
            }
            return { tags, confidences };
        }
        
        // æ›´æ–°æ ‡ç­¾é€‰æ‹©å™¨
        function updateTagSelector() {
            tagSelector.innerHTML = '';
            const sortedEnTags = Array.from(allTags.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            sortedEnTags.forEach(([enTag, count]) => {
                const zhTag = enToZhMap.get(enTag) || enTag;
                const tagItem = document.createElement('div');
                tagItem.className = 'tag-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `tag-${enTag}`;
                checkbox.value = enTag;
                const label = document.createElement('label');
                label.htmlFor = `tag-${enTag}`;
                label.textContent = zhTag;
                const countSpan = document.createElement('span');
                countSpan.className = 'tag-count';
                countSpan.textContent = `(${count})`;
                label.appendChild(countSpan);
                tagItem.appendChild(checkbox);
                tagItem.appendChild(label);
                tagSelector.appendChild(tagItem);
            });
        }
        
        // ç­›é€‰æ ‡ç­¾
        function filterTags() {
            const searchTerm = tagSearchInput.value.toLowerCase().trim();
            const tagItems = tagSelector.querySelectorAll('.tag-item');
            
            tagItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const label = item.querySelector('label');
                const shownText = label.textContent.toLowerCase();
                
                let match = false;
                
                // åŸºç¡€æœç´¢åŒ¹é…
                if (searchTerm === '') {
                    match = true;
                } else {
                    const enTag = checkbox.value.toLowerCase();
                    if (shownText.includes(searchTerm)) match = true;
                    else if (enTag.includes(searchTerm)) match = true;
                }
                
                // å…³é”®ä¿®æ”¹ï¼šå¦‚æœå¼€å¯äº†"åªçœ‹å·²é€‰"æ¨¡å¼ï¼Œåªæ˜¾ç¤ºå·²å‹¾é€‰çš„æ ‡ç­¾
                if (showSelectedOnly && match) {
                    match = checkbox.checked;
                }
                
                item.style.display = match ? 'flex' : 'none';
            });
        }
        
        // å…¨é€‰æ ‡ç­¾
        function selectAllTags() {
            const visibleCheckboxes = tagSelector.querySelectorAll('.tag-item:not([style*="display: none"]) input[type="checkbox"]');
            visibleCheckboxes.forEach(checkbox => { checkbox.checked = true; });
            // å¦‚æœå¼€å¯äº†"åªçœ‹å·²é€‰"æ¨¡å¼ï¼Œæ›´æ–°æ˜¾ç¤º
            if (showSelectedOnly) {
                filterTags();
            }
        }
        
        // å–æ¶ˆå…¨é€‰æ ‡ç­¾
        function deselectAllTags() {
            const checkboxes = tagSelector.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => { checkbox.checked = false; });
            // å¦‚æœå¼€å¯äº†"åªçœ‹å·²é€‰"æ¨¡å¼ï¼Œæ›´æ–°æ˜¾ç¤º
            if (showSelectedOnly) {
                filterTags();
            }
        }
        
        // ç­›é€‰å›¾ç‰‡
        function filterImages() {
            const selectedCheckboxes = tagSelector.querySelectorAll('input[type="checkbox"]:checked');
            const selectedEnTags = Array.from(selectedCheckboxes).map(cb => cb.value);
            const minConfidence = parseFloat(confidenceSlider.value);
            
            // ä¿å­˜å½“å‰æ˜¯å¦æ¿€æ´»æ—¶é—´æ’åºçš„çŠ¶æ€
            const wasTimeSortActive = isTimeSortActive;
            
            // åˆ›å»ºæ–°çš„ç­›é€‰æ•°ç»„
            let newFilteredImages = imageData.filter(image => {
                // æ ‡ç­¾ç­›é€‰é€»è¾‘
                if (selectedEnTags.length > 0) {
                    if (filterLogic === 'intersection') {
                        // äº¤é›†æ¨¡å¼ï¼šæ‰€æœ‰é€‰ä¸­æ ‡ç­¾éƒ½å¿…é¡»å­˜åœ¨ä¸”æ»¡è¶³ç½®ä¿¡åº¦è¦æ±‚
                        if (!selectedEnTags.every(tag => {
                            const tagIndex = image.tags.indexOf(tag);
                            return tagIndex !== -1 && image.confidences[tagIndex] >= minConfidence;
                        })) return false;
                    } else {
                        // å¹¶é›†æ¨¡å¼ï¼šè‡³å°‘ä¸€ä¸ªé€‰ä¸­æ ‡ç­¾å­˜åœ¨ä¸”æ»¡è¶³ç½®ä¿¡åº¦è¦æ±‚
                        if (!selectedEnTags.some(tag => {
                            const tagIndex = image.tags.indexOf(tag);
                            return tagIndex !== -1 && image.confidences[tagIndex] >= minConfidence;
                        })) return false;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ ‡ç­¾ï¼Œä½†è®¾ç½®äº†ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œæ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰ä»»æ„æ ‡ç­¾æ»¡è¶³è¦æ±‚
                if (selectedEnTags.length === 0 && minConfidence > 0) {
                    if (!image.confidences.some(c => c >= minConfidence)) return false;
                }

                return true;
            });

            // å…³é”®ä¿®å¤ï¼šå¦‚æœæ—¶é—´æ’åºæ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå¯¹æ–°ç­›é€‰çš„ç»“æœè¿›è¡Œæ—¶é—´æ’åº
            if (wasTimeSortActive && newFilteredImages.length > 0) {
                newFilteredImages.sort((a, b) => {
                    const dateA = a.modifyDate ? new Date(a.modifyDate).getTime() : 0;
                    const dateB = b.modifyDate ? new Date(b.modifyDate).getTime() : 0;
                    return dateB - dateA; // é™åºæ’åˆ—ï¼Œæœ€æ–°åœ¨å‰
                });
                
                // æ›´æ–°åŸå§‹é¡ºåºï¼Œè¿™æ ·å–æ¶ˆæ—¶é—´æ’åºæ—¶å¯ä»¥æ­£ç¡®æ¢å¤
                originalImageOrder = [...newFilteredImages];
            } else {
                // å¦‚æœæ—¶é—´æ’åºæœªæ¿€æ´»ï¼Œæ¸…ç©ºåŸå§‹é¡ºåºè®°å½•
                originalImageOrder = [];
            }
            
            // æ›´æ–°ç­›é€‰åçš„å›¾ç‰‡æ•°ç»„
            filteredImages = newFilteredImages;
            
            // ç¡®ä¿æ—¶é—´æ’åºçŠ¶æ€æ­£ç¡®åŒæ­¥
            if (wasTimeSortActive) {
                // å¦‚æœä¹‹å‰æ˜¯æ—¶é—´æ’åºçŠ¶æ€ï¼Œä¿æŒæ¿€æ´»
                const timeSortBtn = document.getElementById('timeSortBtn');
                if (timeSortBtn && !timeSortBtn.classList.contains('active')) {
                    timeSortBtn.textContent = 'â° æ—¶é—´æ’åºä¸­ âœ“';
                    timeSortBtn.classList.add('active');
                }
                isTimeSortActive = true;
            }
            
            // é‡æ–°æ˜¾ç¤ºå›¾ç‰‡
            displayImages();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        }

        
        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            tagSearchInput.value = '';
            deselectAllTags();
            confidenceSlider.value = 0.5;
            confidenceValue.textContent = '0.50';
            // é‡ç½®"åªçœ‹å·²é€‰"çŠ¶æ€
            if (showSelectedOnly) {
                showSelectedOnly = false;
                showSelectedBtn.classList.remove('selected-view');
                showSelectedBtn.textContent = 'ğŸ‘ï¸ åªçœ‹å·²é€‰';
            }
            filterTags();
            setFilterLogic('intersection');
            filteredImages = [...imageData];
            displayImages();
            updateStats();
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ·»åŠ å¹¶è¡ŒåŠ è½½å’ŒåŠ è½½çŠ¶æ€æ˜¾ç¤º
        // æ›¿æ¢åŸdisplayImageså‡½æ•°
        function displayImages() {
            imageGrid.innerHTML = '';
            if (filteredImages.length === 0) {
                imageGrid.innerHTML = '<div class="no-data">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡</div>';
                // éšè—æ—¶é—´æ˜¾ç¤º
                showTimeDisplay(false);
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„è§‚å¯Ÿå’Œç¼“å­˜
            visibleImageIndices.clear();
            if (observer) {
                observer.disconnect();
            }
            
            // ç§»é™¤ä¹‹å‰çš„æ»šåŠ¨ç›‘å¬
            removePreviewScrollListener();
            
            // åˆ›å»ºæ‡’åŠ è½½å ä½ç¬¦
            createLazyPlaceholders();
            
            // åˆå§‹åŒ–IntersectionObserver
            initIntersectionObserver();
            
            // è®¾ç½®æ–°çš„é¢„è§ˆåŒºæ»‘æ¡ç›‘å¬
            setupPreviewScrollListener();
            
            updateStats();
            
            // åˆå§‹éšè—æ—¶é—´æ˜¾ç¤º
            setTimeout(() => {
                showTimeDisplay(false);
            }, 100);
        }

        function removePreviewScrollListener() {
            const previewSection = document.querySelector('.preview-section');
            if (!previewSection) return;
            
            // ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†åŒ¿åå‡½æ•°ï¼Œä¸èƒ½ç›´æ¥ç§»é™¤
            // æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å…ƒç´ ä¸Šå­˜å‚¨å¤„ç†å‡½æ•°å¼•ç”¨
            if (previewSection._scrollHandler) {
                previewSection.removeEventListener('scroll', previewSection._scrollHandler);
            }
            if (previewSection._wheelHandler) {
                previewSection.removeEventListener('wheel', previewSection._wheelHandler);
            }
        }

        function initTimeDisplayFeature() {
            // åˆ›å»ºæ—¶é—´æ˜¾ç¤ºå®¹å™¨
            createTimeDisplay();
            
            // è®¾ç½®åˆå§‹çŠ¶æ€
            showTimeDisplay(false);
            
            console.log('æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨
        document.addEventListener('DOMContentLoaded', function() {
            // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
            initTimeDisplayFeature();
        });

        setupFallbackPreloadSystem();

        // æ–°å¢ï¼šåˆ›å»ºæ‡’åŠ è½½å ä½ç¬¦

        // ä¿®å¤åçš„IntersectionObserveré…ç½®
        // å¢å¼ºçš„IntersectionObserveré…ç½®
        // ä¿®æ”¹åçš„æ‡’åŠ è½½åˆå§‹åŒ–å‡½æ•°
        // ä¿®å¤IntersectionObserveré…ç½®
        function initIntersectionObserver() {
            if (observer) {
                observer.disconnect();
            }
            
            // ç§»é™¤trackVisibilityé€‰é¡¹ï¼Œå› ä¸ºå®ƒä¸æ˜¯å¿…é¡»çš„
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const index = parseInt(entry.target.dataset.index);
                    const card = entry.target;
                    
                    if (entry.isIntersecting) {
                        visibleImageIndices.add(index);
                        
                        // ç«‹å³åŠ è½½è¿›å…¥æ‰©å¤§åˆ¤å®šåŒºåŸŸçš„å›¾ç‰‡
                        if (card.dataset.loaded === 'false') {
                            loadSingleImage(index, true); // é«˜ä¼˜å…ˆçº§åŠ è½½
                        }
                        
                        // æ™ºèƒ½é¢„åŠ è½½é™„è¿‘å›¾ç‰‡
                        smartPreloadAdjacentImages(index);
                    } else {
                        visibleImageIndices.delete(index);
                    }
                });
            }, {
                rootMargin: '1000px 0px 1000px 0px', // ä¸Šä¸‹å„æ‰©å±•1000pxè§¦å‘åŒºåŸŸ
                threshold: 0.001
                // ç§»é™¤äº†trackVisibilityå’Œdelayé€‰é¡¹
            });

            // è§‚å¯Ÿæ‰€æœ‰å ä½ç¬¦
            document.querySelectorAll('.lazy-placeholder').forEach(placeholder => {
                observer.observe(placeholder);
            });
            
            // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–åŠ è½½
            setupScrollOptimization();
        }

        

        // æ–°å¢ï¼šæ™ºèƒ½é¢„åŠ è½½ç›¸é‚»å›¾ç‰‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function smartPreloadAdjacentImages(currentIndex) {
            const preloadDistance = Math.min(30, Math.ceil(filteredImages.length * 0.1)); // åŠ¨æ€è®¡ç®—é¢„åŠ è½½èŒƒå›´
            const preloadCount = 15; // å¢åŠ é¢„åŠ è½½æ•°é‡
            
            // è®¡ç®—é¢„åŠ è½½èŒƒå›´ï¼ˆå‰åå„preloadDistanceå¼ ï¼‰
            const start = Math.max(0, currentIndex - preloadDistance);
            const end = Math.min(filteredImages.length - 1, currentIndex + preloadDistance);
            
            // æ”¶é›†éœ€è¦é¢„åŠ è½½çš„ç´¢å¼•ï¼ŒæŒ‰è·ç¦»æ’åº
            const indicesToLoad = [];
            for (let i = start; i <= end; i++) {
                const card = document.querySelector(`.lazy-placeholder[data-index="${i}"]`);
                if (card && card.dataset.loaded === 'false') {
                    const distance = Math.abs(i - currentIndex);
                    indicesToLoad.push({ index: i, distance: distance });
                }
            }
            
            // æŒ‰è·ç¦»æ’åºï¼Œä¼˜å…ˆåŠ è½½è¿‘çš„å›¾ç‰‡
            indicesToLoad.sort((a, b) => a.distance - b.distance);
            
            // åˆ†æ‰¹åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤š
            const batchSize = 5;
            indicesToLoad.slice(0, preloadCount).forEach((item, i) => {
                setTimeout(() => {
                    if (loadedImageCount < maxLoadedImages) {
                        const priority = item.distance <= 10; // è·ç¦»10ä»¥å†…çš„å›¾ç‰‡é«˜ä¼˜å…ˆçº§
                        loadSingleImage(item.index, priority);
                    }
                }, i * 50); // åˆ†æ‰¹å»¶è¿ŸåŠ è½½ï¼Œé¿å…é˜»å¡
            });
        }

        // æ–°å¢ï¼šæ»šåŠ¨ä¼˜åŒ–è®¾ç½®
        function setupScrollOptimization() {
            let scrollTimeout = null;
            let lastScrollY = window.scrollY;
            let scrollDirection = 0; // 1å‘ä¸‹ï¼Œ-1å‘ä¸Š
            
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                scrollDirection = currentScrollY > lastScrollY ? 1 : -1;
                lastScrollY = currentScrollY;
                
                // é˜²æŠ–å¤„ç†
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // æ»šåŠ¨åœæ­¢åæ£€æŸ¥å¯è§æ€§
                    checkExtendedVisibility();
                    
                    // æ ¹æ®æ»šåŠ¨æ–¹å‘é¢„åŠ è½½
                    preloadInScrollDirection(scrollDirection);
                }, 100);
            }, { passive: true });
        }

        // æ–°å¢ï¼šæ‰©å±•å¯è§æ€§æ£€æŸ¥
        function checkExtendedVisibility() {
            const viewportHeight = window.innerHeight;
            const scrollY = window.scrollY;
            
            // è®¡ç®—æ‰©å±•çš„å¯è§åŒºåŸŸï¼ˆä¸Šä¸‹å„æ‰©å±•2å€è§†å£é«˜åº¦ï¼‰
            const extendedTop = scrollY - viewportHeight * 2;
            const extendedBottom = scrollY + viewportHeight * 3;
            
            document.querySelectorAll('.lazy-placeholder').forEach(card => {
                const rect = card.getBoundingClientRect();
                const cardTop = rect.top + scrollY;
                const cardBottom = rect.bottom + scrollY;
                const index = parseInt(card.dataset.index);
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ‰©å±•å¯è§åŒºåŸŸå†…
                const isInExtendedView = (cardBottom > extendedTop && cardTop < extendedBottom);
                
                if (isInExtendedView && card.dataset.loaded === 'false') {
                    if (loadedImageCount < maxLoadedImages) {
                        // è®¡ç®—ä¼˜å…ˆçº§ï¼šè·ç¦»è§†å£è¶Šè¿‘ä¼˜å…ˆçº§è¶Šé«˜
                        const viewportMiddle = scrollY + viewportHeight / 2;
                        const cardMiddle = (cardTop + cardBottom) / 2;
                        const distanceToViewport = Math.abs(cardMiddle - viewportMiddle);
                        const priority = distanceToViewport < viewportHeight;
                        
                        loadSingleImage(index, priority);
                    }
                }
            });
        }

        // æ–°å¢ï¼šæ ¹æ®æ»šåŠ¨æ–¹å‘é¢„åŠ è½½
        function preloadInScrollDirection(direction) {
            if (filteredImages.length === 0) return;
            
            // è·å–å½“å‰å¯è§å›¾ç‰‡çš„ç´¢å¼•èŒƒå›´
            const visibleIndices = Array.from(visibleImageIndices);
            if (visibleIndices.length === 0) return;
            
            // æ ¹æ®æ»šåŠ¨æ–¹å‘ç¡®å®šé¢„åŠ è½½èŒƒå›´
            let targetIndex;
            if (direction > 0) {
                // å‘ä¸‹æ»šåŠ¨ï¼Œé¢„åŠ è½½åé¢çš„å›¾ç‰‡
                targetIndex = Math.max(...visibleIndices) + 1;
            } else {
                // å‘ä¸Šæ»šåŠ¨ï¼Œé¢„åŠ è½½å‰é¢çš„å›¾ç‰‡
                targetIndex = Math.min(...visibleIndices) - 1;
            }
            
            // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
            targetIndex = Math.max(0, Math.min(targetIndex, filteredImages.length - 1));
            
            // é¢„åŠ è½½ç›®æ ‡ç´¢å¼•é™„è¿‘çš„å›¾ç‰‡
            if (targetIndex >= 0 && targetIndex < filteredImages.length) {
                smartPreloadAdjacentImages(targetIndex);
            }
        }

        // ä¿®æ”¹loadSingleImageå‡½æ•°ï¼Œæ”¯æŒä¼˜å…ˆçº§å’Œå–æ¶ˆæœºåˆ¶
        function loadSingleImage(index, priority = false) {
            // å¦‚æœå·²æœ‰å¤ªå¤šåŠ è½½ä»»åŠ¡ï¼Œå–æ¶ˆä½ä¼˜å…ˆçº§ä»»åŠ¡
            if (!priority && getPendingRequestCount() > 8) {
                cancelLowPriorityRequests();
                return;
            }
            
            const image = filteredImages[index];
            const card = document.querySelector(`.lazy-placeholder[data-index="${index}"]`);
            
            if (!card || card.dataset.loaded === 'true') return;
            
            // æ£€æŸ¥ç¼“å­˜
            if (imageCache.has(image.path)) {
                updateCardWithImage(card, imageCache.get(image.path), index);
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const placeholder = card.querySelector('.image-placeholder');
            if (placeholder) {
                if (priority) {
                    placeholder.innerHTML = '<div class="loading-spinner"></div><div>ä¼˜å…ˆåŠ è½½ä¸­...</div>';
                } else {
                    placeholder.innerHTML = '<div class="loading-spinner"></div><div>é¢„åŠ è½½ä¸­...</div>';
                }
            }
            
            const img = new Image();
            const requestId = `img_${index}_${Date.now()}`;
            
            // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
            pendingRequests.set(requestId, {
                img: img,
                index: index,
                priority: priority,
                startTime: Date.now(),
                card: card
            });
            
            img.onload = () => {
                // æ¸…ç†è¯·æ±‚è®°å½•
                pendingRequests.delete(requestId);
                
                // ç¼“å­˜å›¾ç‰‡
                imageCache.set(image.path, img);
                loadedImageCount++;
                updateCardWithImage(card, img, index);
            };
            
            img.onerror = () => {
                // æ¸…ç†è¯·æ±‚è®°å½•
                pendingRequests.delete(requestId);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                if (placeholder) {
                    placeholder.innerHTML = '<div>âŒ åŠ è½½å¤±è´¥</div>';
                }
                card.dataset.loaded = 'error';
            };
            
            // æ ¹æ®ä¼˜å…ˆçº§å†³å®šåŠ è½½æ—¶æœº
            if (priority) {
                // é«˜ä¼˜å…ˆçº§ç«‹å³åŠ è½½
                img.src = image.path;
            } else {
                // ä½ä¼˜å…ˆçº§ä½¿ç”¨requestIdleCallback
                requestIdleCallback(() => {
                    if (pendingRequests.has(requestId)) {
                        img.src = image.path;
                    }
                }, { timeout: 1000 });
            }
        }

        // æ–°å¢ï¼šè·å–è¿›è¡Œä¸­çš„è¯·æ±‚æ•°é‡
        function getPendingRequestCount() {
            return pendingRequests.size;
        }


        // æ–°å¢ï¼šæ™ºèƒ½é¢„åŠ è½½ç­–ç•¥
        function smartPreloadImages(currentIndex) {
            const preloadCount = 20; // æ¯æ¬¡é¢„åŠ è½½æ•°é‡
            const preloadDistance = 60; // é¢„åŠ è½½èŒƒå›´
            
            // è®¡ç®—é¢„åŠ è½½èŒƒå›´
            const start = Math.max(0, currentIndex - preloadDistance);
            const end = Math.min(filteredImages.length - 1, currentIndex + preloadDistance);
            
            // æ”¶é›†éœ€è¦é¢„åŠ è½½çš„ç´¢å¼•
            const indicesToLoad = [];
            for (let i = start; i <= end; i++) {
                const card = document.querySelector(`.lazy-placeholder[data-index="${i}"]`);
                if (card && card.dataset.loaded === 'false') {
                    indicesToLoad.push(i);
                }
            }
            
            // æŒ‰è·ç¦»å½“å‰ç´¢å¼•çš„è¿œè¿‘æ’åº
            indicesToLoad.sort((a, b) => {
                return Math.abs(a - currentIndex) - Math.abs(b - currentIndex);
            });
            
            // åŠ è½½æœ€è¿‘çš„å‡ å¼ å›¾ç‰‡
            indicesToLoad.slice(0, preloadCount).forEach(index => {
                if (loadedImageCount < maxLoadedImages) {
                    loadSingleImage(index);
                }
            });
        }


        // å¢å¼ºçš„é¢„åŠ è½½å‡½æ•°
        function preloadAdjacentImages(currentIndex, range = 3) {
            const start = Math.max(0, currentIndex - range);
            const end = Math.min(filteredImages.length - 1, currentIndex + range);
            
            // æŒ‰è·ç¦»æ’åºï¼Œå…ˆåŠ è½½æœ€è¿‘çš„
            const indicesToLoad = [];
            for (let i = start; i <= end; i++) {
                if (i !== currentIndex) {
                    indicesToLoad.push(i);
                }
            }
            
            // æŒ‰ä¸å½“å‰å›¾ç‰‡çš„è·ç¦»æ’åº
            indicesToLoad.sort((a, b) => {
                return Math.abs(a - currentIndex) - Math.abs(b - currentIndex);
            });


            // åŠ è½½æ’åºåçš„å›¾ç‰‡
            for (const index of indicesToLoad) {
                const card = document.querySelector(`.lazy-placeholder[data-index="${index}"]`);
                if (card && card.dataset.loaded === 'false' && loadedImageCount < maxLoadedImages) {
                    loadSingleImage(index);
                }
            }
        }


        // ç¡®ä¿åœ¨æ»šåŠ¨æ—¶ä¹Ÿèƒ½è§¦å‘åŠ è½½
        function setupScrollListener() {
            let lastScrollPosition = window.scrollY;
            
            window.addEventListener('scroll', () => {
                const currentScrollPosition = window.scrollY;
                // åªæœ‰æ»šåŠ¨è¶…è¿‡ä¸€å®šè·ç¦»æ‰æ£€æŸ¥
                if (Math.abs(currentScrollPosition - lastScrollPosition) > 50) {
                    checkVisibleImages();
                    lastScrollPosition = currentScrollPosition;
                }
            });
        }




        // åˆå§‹åŒ–æ—¶è°ƒç”¨
        function initLazyLoad() {
            createLazyPlaceholders();
            initIntersectionObserver();
            setupScrollListener();
            
            // åˆå§‹åŠ è½½é¦–å±å›¾ç‰‡
            setTimeout(() => {
                checkVisibleImages();
            }, 300);
        }
        
        // å¤„ç†å›¾ç‰‡åŠ è½½é˜Ÿåˆ—
        function processLoadingQueue(progressInfo, loadedCount) {
            // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œç§»é™¤è¿›åº¦ä¿¡æ¯
            if (loadingQueue.length === 0) {
                if (progressInfo.parentNode) {
                    progressInfo.parentNode.removeChild(progressInfo);
                }
                return;
            }
            
            // å¯åŠ¨æ–°çš„åŠ è½½ä»»åŠ¡ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§å¹¶å‘æ•°
            while (currentLoads < maxConcurrentLoads && loadingQueue.length > 0) {
                const item = loadingQueue.shift();
                loadImage(item, progressInfo, loadedCount);
                currentLoads++;
            }
        }
        
        // æ–°å¢ï¼šåŠ è½½å¯è§åŒºåŸŸçš„å›¾ç‰‡
        function loadVisibleImages() {
            const indicesToLoad = Array.from(visibleImageIndices)
                .filter(index => {
                    const card = document.querySelector(`.lazy-placeholder[data-index="${index}"]`);
                    return card && card.dataset.loaded === 'false';
                })
                .slice(0, 20); // æ¯æ¬¡æœ€å¤šåŠ è½½20å¼ 
            
            indicesToLoad.forEach(index => {
                if (loadedImageCount < maxLoadedImages) {
                    loadSingleImage(index, true);
                }
            });
        }

        function setupFallbackPreloadSystem() {
            console.group('ğŸ”„ è®¾ç½®å¤‡ç”¨é¢„åŠ è½½ç³»ç»Ÿ');
            
            // 1. åœæ­¢ç°æœ‰ Observer
            if (observer) {
                observer.disconnect();
                observer = null;
            }
            
            // 2. æ¸…ç©ºé›†åˆ
            visibleImageIndices.clear();
            
            // 3. è®¾ç½®æ»šåŠ¨ç›‘å¬
            let lastScrollTime = 0;
            let scrollTimer = null;
            
                function checkAndPreload() {
                    const now = Date.now();
                    if (now - lastScrollTime < 200) return;
                    lastScrollTime = now;
                    
                    const placeholders = document.querySelectorAll('.lazy-placeholder');
                    const viewportHeight = window.innerHeight;
                    const preloadDistance = 2000; // å¢å¤§é¢„åŠ è½½è·ç¦»ï¼Œæ¯”å¦‚2000px
                    
                    console.log(`ğŸ” æ£€æŸ¥ ${placeholders.length} ä¸ªå…ƒç´ `);
                    
                    placeholders.forEach(placeholder => {
                        const rect = placeholder.getBoundingClientRect();
                        const index = parseInt(placeholder.dataset.index);
                        const distance = rect.top; // è·ç¦»è§†å£é¡¶éƒ¨çš„è·ç¦»
                        
                        // âœ… ä¿®æ”¹1ï¼šç§»é™¤"åœ¨è§†å£å†…"çš„æ¡ä»¶åˆ¤æ–­
                        // åªè¦åœ¨é¢„åŠ è½½åŒºåŸŸå†…ï¼Œå°±ç«‹å³åŠ è½½
                        if (distance <= viewportHeight + preloadDistance && distance >= -preloadDistance) {
                            if (!visibleImageIndices.has(index)) {
                                visibleImageIndices.add(index);
                            }
                            
                            // âœ… ä¿®æ”¹2ï¼šä¸å†æ£€æŸ¥æ˜¯å¦åœ¨è§†å£å†…ï¼Œæ‰€æœ‰åœ¨é¢„åŠ è½½åŒºçš„éƒ½é«˜ä¼˜å…ˆçº§åŠ è½½
                            if (placeholder.dataset.loaded === 'false') {
                                // âœ… ä¿®æ”¹3ï¼šå…¨éƒ¨ä½¿ç”¨é«˜ä¼˜å…ˆçº§åŠ è½½
                                loadSingleImage(index, true); // æ€»æ˜¯true
                            }
                        } else if (distance > viewportHeight + preloadDistance + 1000) {
                            visibleImageIndices.delete(index);
                        }
                    });
                    
                    console.log(`ğŸ“Š å½“å‰åœ¨é¢„åŠ è½½åŒº: ${visibleImageIndices.size} ä¸ªå…ƒç´ `);
                }
            
            
            // 4. è®¾ç½®ç›‘å¬
            window.addEventListener('scroll', () => {
                if (scrollTimer) clearTimeout(scrollTimer);
                scrollTimer = setTimeout(checkAndPreload, 50);
            });
            
            // 5. ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            setTimeout(checkAndPreload, 1000);
            
            // 6. å®šæœŸæ£€æŸ¥
            setInterval(checkAndPreload, 10000);
            
            console.log('âœ… å¤‡ç”¨é¢„åŠ è½½ç³»ç»Ÿå·²å¯åŠ¨');
            console.groupEnd();
            
            return 'å¤‡ç”¨ç³»ç»Ÿè¿è¡Œä¸­';
        }

        // æ–°å¢ï¼šåŠ è½½å•å¼ å›¾ç‰‡
        // æ–°å¢å…¨å±€å˜é‡
        const pendingRequests = new Map(); // å­˜å‚¨è¿›è¡Œä¸­çš„è¯·æ±‚
        const retryCounts = new Map(); // å­˜å‚¨é‡è¯•æ¬¡æ•°
        const MAX_RETRIES = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°


        // æ–°å¢ï¼šå–æ¶ˆä½ä¼˜å…ˆçº§è¯·æ±‚
        function cancelLowPriorityRequests() {
            const now = Date.now();
            const toCancel = [];
            
            // æ‰¾å‡ºå¾…å–æ¶ˆçš„è¯·æ±‚
            pendingRequests.forEach((req, id) => {
                if (!req.priority && now - req.timestamp > 1000) {
                    toCancel.push(id);
                }
            });
            
            // æ‰§è¡Œå–æ¶ˆ
            toCancel.forEach(id => {
                const req = pendingRequests.get(id);
                if (req) {
                    req.img.onload = null;
                    req.img.onerror = null;
                    req.img.src = '';
                    pendingRequests.delete(id);
                    
                    // æ¢å¤å ä½ç¬¦çŠ¶æ€
                    const card = document.querySelector(`.lazy-placeholder[data-index="${req.index}"]`);
                    if (card && card.dataset.loaded === 'false') {
                        const placeholder = card.querySelector('.image-placeholder');
                        placeholder.innerHTML = '<div>æ»‘åŠ¨åˆ°æ­¤å¤„è‡ªåŠ¨åŠ è½½</div>';
                    }
                }
            });
        }

        // æ–°å¢ï¼šæ™ºèƒ½å¸è½½å›¾ç‰‡
        function smartUnloadImages() {
            const viewportHeight = window.innerHeight;
            const scrollPosition = window.scrollY;
            
            document.querySelectorAll('.image-card:not(.lazy-placeholder)').forEach(card => {
                const rect = card.getBoundingClientRect();
                const index = parseInt(card.dataset.index);
                
                // è®¡ç®—å…ƒç´ æ˜¯å¦è¿œç¦»è§†å£
                const isFarFromViewport = (
                    rect.bottom < -viewportHeight * 2 || 
                    rect.top > viewportHeight * 3
                );
                
                if (isFarFromViewport && loadedImageCount > maxLoadedImages * 0.7) {
                    // è½¬æ¢ä¸ºå ä½ç¬¦
                    card.innerHTML = '';
                    card.className = 'image-card lazy-placeholder';
                    card.dataset.loaded = 'false';
                    
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-placeholder';
                    placeholder.innerHTML = '<div>å›¾ç‰‡å·²å¸è½½ï¼Œæ»‘åŠ¨åˆ°æ­¤å¤„é‡æ–°åŠ è½½</div>';
                    card.appendChild(placeholder);
                    
                    loadedImageCount--;
                    
                    // é‡æ–°è§‚å¯Ÿ
                    if (observer) {
                        observer.observe(card);
                    }
                }
            });
        }


        // æ–°å¢ï¼šæ›´æ–°å¡ç‰‡æ˜¾ç¤ºçœŸå®å›¾ç‰‡
        function updateCardWithImage(card, img, index) {
            const image = filteredImages[index];
            card.innerHTML = '';
            card.className = 'image-card';
            card.dataset.loaded = 'true';
            
            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';
            imgContainer.appendChild(img.cloneNode());
            
            // åˆ›å»ºæ ‡ç­¾æ˜¾ç¤ºï¼ˆä¸åŸä»£ç ç›¸åŒï¼‰
            const imageTags = document.createElement('div');
            imageTags.className = 'image-tags';
            
            const selectedCheckboxes = tagSelector.querySelectorAll('input[type="checkbox"]:checked');
            const selectedEnTags = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            const tagConfPairs = image.tags.map((tag, index) => ({
                tag,
                confidence: image.confidences[index]
            }));
            
            tagConfPairs.sort((a, b) => {
                const aSelected = selectedEnTags.includes(a.tag);
                const bSelected = selectedEnTags.includes(b.tag);
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return b.confidence - a.confidence;
            });
            
            tagConfPairs.slice(0, maxDisplayedTags).forEach(({tag}) => {
                const zhTag = enToZhMap.get(tag) || tag;
                const tagPill = document.createElement('span');
                tagPill.className = 'tag-pill';
                tagPill.textContent = zhTag;
                tagPill.title = `${tag} â†’ ${zhTag}`;
                imageTags.appendChild(tagPill);
            });
            
            if (image.tags.length > maxDisplayedTags && maxDisplayedTags !== 0) {
                const moreTag = document.createElement('span');
                moreTag.className = 'tag-pill';
                moreTag.textContent = `+${image.tags.length - maxDisplayedTags}`;
                imageTags.appendChild(moreTag);
            }
            
            card.appendChild(imgContainer);
            card.appendChild(imageTags);
            
            // é‡æ–°æ·»åŠ ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', () => {
                showPreviewModal(image, index);
            });
            
            // é‡æ–°è§‚å¯Ÿæ›´æ–°åçš„å…ƒç´ 
            if (observer) {
                observer.observe(card);
            }
        }

        // åŠ è½½å•ä¸ªå›¾ç‰‡
        function loadImage(item, progressInfo, loadedCount) {
            const { imagePath, card, imgContainer, loadingOverlay } = item;
            
            // æ£€æŸ¥ç¼“å­˜
            if (imageCache.has(imagePath)) {
                const cachedImg = imageCache.get(imagePath);
                updateImageCard(card, imgContainer, loadingOverlay, cachedImg);
                currentLoads--;
                loadedCount++;
                progressInfo.textContent = `åŠ è½½ä¸­: ${loadedCount}/${filteredImages.length}`;
                processLoadingQueue(progressInfo, loadedCount);
                return;
            }
            
            const img = new Image();
            img.onload = () => {
                // ç¼“å­˜å›¾ç‰‡
                imageCache.set(imagePath, img);
                updateImageCard(card, imgContainer, loadingOverlay, img);
                currentLoads--;
                loadedCount++;
                progressInfo.textContent = `åŠ è½½ä¸­: ${loadedCount}/${filteredImages.length}`;
                processLoadingQueue(progressInfo, loadedCount);
            };
            
            img.onerror = () => {
                // å›¾ç‰‡åŠ è½½å¤±è´¥
                const errorStatus = document.createElement('div');
                errorStatus.className = 'image-status';
                const errorIcon = document.createElement('div');
                errorIcon.className = 'error-icon';
                errorIcon.textContent = 'âŒ';
                const errorText = document.createElement('div');
                errorText.textContent = 'åŠ è½½å¤±è´¥';
                errorStatus.appendChild(errorIcon);
                errorStatus.appendChild(errorText);
                imgContainer.appendChild(errorStatus);
                
                loadingOverlay.style.display = 'none';
                currentLoads--;
                loadedCount++;
                progressInfo.textContent = `åŠ è½½ä¸­: ${loadedCount}/${filteredImages.length}`;
                processLoadingQueue(progressInfo, loadedCount);
            };
            
            // å¼€å§‹åŠ è½½å›¾ç‰‡
            img.src = imagePath;
        }
        
        // æ›´æ–°å›¾ç‰‡å¡ç‰‡æ˜¾ç¤º
        function updateImageCard(card, imgContainer, loadingOverlay, img) {
            // ç§»é™¤å ä½ç¬¦å’ŒåŠ è½½çŠ¶æ€
            const placeholder = imgContainer.querySelector('.loading-placeholder');
            if (placeholder) {
                imgContainer.removeChild(placeholder);
            }
            
            loadingOverlay.style.display = 'none';
            
            // æ·»åŠ å›¾ç‰‡åˆ°å®¹å™¨
            imgContainer.appendChild(img);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            stats.textContent = `æ€»å›¾ç‰‡: ${imageData.length} | ç­›é€‰: ${filteredImages.length} | æ ‡ç­¾æ•°: ${allTags.size}`;
        }
        
        // å¯¼å‡ºç­›é€‰ç»“æœ
        function exportFilteredResults() {
            if (filteredImages.length === 0) {
                alert('æ²¡æœ‰ç­›é€‰ç»“æœå¯å¯¼å‡º');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,æ–‡ä»¶è·¯å¾„,æ–‡ä»¶å,æ ‡ç­¾(è‹±æ–‡),æ ‡ç­¾(ä¸­æ–‡),ç½®ä¿¡åº¦åˆ—è¡¨,æœ€é«˜ç½®ä¿¡åº¦\n";
            filteredImages.forEach(image => {
                const maxConf = Math.max(...image.confidences);
                const enTags = image.tags.join(',');
                const zhTags = image.tags.map(t => enToZhMap.get(t) || t).join(',');
                const row = [
                    image.path,
                    image.path.split('/').pop() || image.path,
                    enTags,
                    zhTags,
                    image.confidences.map(c => c.toFixed(2)).join(','),
                    maxConf.toFixed(2)
                ].map(field => `"${field.replace(/"/g, '""')}"`).join(',');
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "filtered_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // æ–°å¢ï¼šæ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        function showPreviewModal(image, index) {
            currentPreviewImage = image;
            currentPreviewIndex = index; // ä¿å­˜å½“å‰ç´¢å¼•
            
            // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            updateNavButtons();
            
            currentPreviewImage = image;
            
            // é‡ç½®ç¼©æ”¾å’Œä½ç½®
            scale = 1;
            translateX = 0;
            translateY = 0;
            previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            zoomValue.textContent = `${Math.round(scale * 100)}%`;
            
            // è®¾ç½®å›¾ç‰‡
            const cachedImg = imageCache.get(image.path);
            if (cachedImg) {
                previewImage.src = cachedImg.src;
                
                // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
                imageName.textContent = image.path.split('/').pop() || image.path;
                imagePath.textContent = image.path;
                imageModifyDate.textContent = 114514;
                
                // è·å–å›¾ç‰‡å¤§å°å’Œåˆ†è¾¨ç‡
                getImageInfo(cachedImg, image);
            } else {
                // å¦‚æœå›¾ç‰‡ä¸åœ¨ç¼“å­˜ä¸­ï¼Œå°è¯•åŠ è½½
                const img = new Image();
                img.onload = () => {
                    previewImage.src = img.src;
                    imageName.textContent = image.path.split('/').pop() || image.path;
                    imagePath.textContent = image.path;
                    getImageInfo(img, image);
                };
                img.onerror = () => {
                    previewImage.src = '';
                    imageName.textContent = 'åŠ è½½å¤±è´¥';
                    imagePath.textContent = image.path;
                    imageSize.textContent = '-';
                    imageResolution.textContent = '-';
                    imageModifyDate.textContent = '-';
                };
                img.src = image.path;
            }
            
            // æ›´æ–°æ ‡ç­¾
            updatePreviewTags(image);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            previewModal.classList.add('active');
        }

        // åˆ‡æ¢åˆ°ä¸Šä¸€å¼ å›¾ç‰‡
        function showPrevImage() {
            if (currentPreviewIndex > 0) {
                const prevIndex = currentPreviewIndex - 1;
                const prevImage = filteredImages[prevIndex];
                showPreviewModal(prevImage, prevIndex);
            }
        }

        // åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
        function showNextImage() {
            if (currentPreviewIndex < filteredImages.length - 1) {
                const nextIndex = currentPreviewIndex + 1;
                const nextImage = filteredImages[nextIndex];
                showPreviewModal(nextImage, nextIndex);
            }
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavButtons() {
            const prevBtn = document.getElementById('prevImageBtn');
            const nextBtn = document.getElementById('nextImageBtn');
            
            if (prevBtn && nextBtn) {
                prevBtn.disabled = currentPreviewIndex === 0;
                nextBtn.disabled = currentPreviewIndex === filteredImages.length - 1;
            }
        }

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        function handleKeyboardNavigation(e) {
            if (!previewModal.classList.contains('active')) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    showPrevImage();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    showNextImage();
                    break;
                case 'Escape':
                    e.preventDefault();
                    closePreviewModal();
                    break;
            }
        }
        
        // æ–°å¢ï¼šè·å–å›¾ç‰‡ä¿¡æ¯
        function getImageInfo(img, image) {
            // è·å–å›¾ç‰‡å¤§å°
            fetch(img.src)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('æ— æ³•è·å–å›¾ç‰‡å¤§å°');
                })
                .then(blob => {
                    const sizeInKB = blob.size / 1024;
                    imageSize.textContent = sizeInKB < 1024 ? 
                        `${sizeInKB.toFixed(1)} KB` : 
                        `${(sizeInKB / 1024).toFixed(1)} MB`;
                })
                .catch(() => {
                    imageSize.textContent = '-';
                });
            // è·å–å›¾ç‰‡ä¿®æ”¹æ—¥æœŸ
            fetch(img.src)
                .then(response => {
                    if (response.ok) {
                        const lastModified = response.headers.get('Last-Modified');
                        if (lastModified) {
                            return new Date(lastModified);
                        }
                        throw new Error('æœåŠ¡å™¨æœªæä¾›ä¿®æ”¹æ—¥æœŸ');
                    }
                    throw new Error('æ— æ³•è·å–å›¾ç‰‡');
                })
                .then(modifyDate => {
                    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                    if (modifyDate instanceof Date) {
                        const formattedDate = `${modifyDate.getFullYear()}-${(modifyDate.getMonth() + 1).toString().padStart(2, '0')}-${modifyDate.getDate().toString().padStart(2, '0')}`;
                        imageModifyDate.textContent = formattedDate;
                    } else {
                        imageModifyDate.textContent = '-';
                    }
                })
                .catch(() => {
                    imageModifyDate.textContent = '-';
                });
            // è·å–å›¾ç‰‡åˆ†è¾¨ç‡
            imageResolution.textContent = `${img.naturalWidth} Ã— ${img.naturalHeight}`;
        }
        
        // æ–°å¢ï¼šæ›´æ–°é¢„è§ˆæ ‡ç­¾
        function updatePreviewTags(image) {
            previewTags.innerHTML = '';
            
            // åˆ›å»ºæ ‡ç­¾å’Œç½®ä¿¡åº¦çš„é…å¯¹æ•°ç»„
            const tagConfPairs = image.tags.map((tag, index) => ({
                tag,
                confidence: image.confidences[index]
            }));
            
            // æŒ‰ç½®ä¿¡åº¦é™åºæ’åº
            tagConfPairs.sort((a, b) => b.confidence - a.confidence);
            
            // æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
            tagConfPairs.forEach(({tag, confidence}) => {
                const zhTag = enToZhMap.get(tag) || tag;
                const tagElement = document.createElement('div');
                tagElement.className = 'preview-tag';
                tagElement.textContent = zhTag;
                tagElement.title = `${tag} (ç½®ä¿¡åº¦: ${confidence.toFixed(2)})`;
                tagElement.dataset.tag = tag;
                
                const confidenceSpan = document.createElement('span');
                confidenceSpan.className = 'preview-tag-confidence';
                confidenceSpan.textContent = confidence.toFixed(2);
                tagElement.appendChild(confidenceSpan);
                
                // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²é€‰ä¸­
                const checkbox = tagSelector.querySelector(`input[value="${tag}"]`);
                if (checkbox && checkbox.checked) {
                    tagElement.classList.add('selected');
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                tagElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTagSelection(tag);
                    tagElement.classList.toggle('selected');
                });
                
                previewTags.appendChild(tagElement);
            });
        }
        
        // æ–°å¢ï¼šåˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
        function toggleTagSelection(tag) {
            const checkbox = tagSelector.querySelector(`input[value="${tag}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }
        
        // æ–°å¢ï¼šå…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        function closePreviewModal() {
            previewModal.classList.remove('active');
            currentPreviewImage = null;
        }
        
        // æ–°å¢ï¼šå¼€å§‹æ‹–åŠ¨å›¾ç‰‡
        function startDrag(e) {
            if (scale <= 0) return;
            
            e.preventDefault(); // å…³é”®ï¼šé˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            isDragging = true;
            startX = e.clientX;  // åªè®°å½•é¼ æ ‡ä½ç½®
            startY = e.clientY;
            initialTranslateX = translateX;  // è®°å½•å›¾ç‰‡å½“å‰ä½ç½®
            initialTranslateY = translateY;
            previewImage.classList.add('dragging');
            previewImage.style.cursor = 'grabbing';

            // å°†äº‹ä»¶ç›‘å¬ç§»åˆ°documentçº§åˆ«
            document.addEventListener('mousemove', dragImage);
            document.addEventListener('mouseup', endDrag);
        }
        
        // æ–°å¢ï¼šæ‹–åŠ¨å›¾ç‰‡
        function dragImage(e) {
            if (!isDragging) return;
            
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            e.stopPropagation();

            // å…³é”®ä¿®å¤ï¼šåŸºäºåˆå§‹çŠ¶æ€çš„ç›¸å¯¹ç§»åŠ¨
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            translateX = initialTranslateX + (e.clientX - startX);
            translateY = initialTranslateY + (e.clientY - startY);
            previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }
        
        // æ–°å¢ï¼šç»“æŸæ‹–åŠ¨
        function endDrag() {
            if (!isDragging) return;
            
            isDragging = false;
            previewImage.classList.remove('dragging');
            previewImage.style.cursor = 'grab';

            // æ¸…ç†documentçº§åˆ«çš„äº‹ä»¶ç›‘å¬
            document.removeEventListener('mousemove', dragImage);
            document.removeEventListener('mouseup', endDrag);
        }
        
        // æ–°å¢ï¼šå¤„ç†æ»šè½®ç¼©æ”¾
        function handleWheel(e) {
            e.preventDefault();
            
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            adjustZoom(delta);
        }
        
        // æ–°å¢ï¼šè°ƒæ•´ç¼©æ”¾
        function adjustZoom(delta) {
            const newScale = Math.max(0.1, Math.min(scale + delta, 10));
            if (newScale !== scale) {
                scale = newScale;
                previewImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                zoomValue.textContent = `${Math.round(scale * 100)}%`;
            }
        }


        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(date) {
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // ä»Šå¤©ï¼šæ˜¾ç¤ºå°æ—¶
                return date.getHours().toString().padStart(2, '0') + ':00';
            } else if (diffDays < 7) {
                // 7å¤©å†…ï¼šæ˜¾ç¤ºå‡ å¤©å‰
                return `${diffDays}å¤©å‰`;
            } else if (diffDays < 30) {
                // 30å¤©å†…ï¼šæ˜¾ç¤ºå‘¨æ•°
                return `${Math.floor(diffDays / 7)}å‘¨å‰`;
            } else if (diffDays < 365) {
                // 365å¤©å†…ï¼šæ˜¾ç¤ºæœˆæ•°
                return `${Math.floor(diffDays / 30)}æœˆå‰`;
            } else {
                // è¶…è¿‡ä¸€å¹´ï¼šæ˜¾ç¤ºå¹´ä»½
                return `${Math.floor(diffDays / 365)}å¹´å‰`;
            }
        }


        
        // åˆå§‹åŒ–å¸ƒå±€ä¸æ»‘æ¡
        applyGridLayout();
        updateMaxTags();
        updateTagColumns();
        updateColors(); // åˆå§‹åŒ–é¢œè‰²
        updatePanelWidth(); // åˆå§‹åŒ–é¢æ¿å®½åº¦
        
        // æ–°å¢ï¼šç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                closePreviewModal();
            }
        });
        // ==================== æ—¶é—´æ’åºç›¸å…³å˜é‡ ====================
        let isTimeSortActive = false;
        let originalImageOrder = []; // ç”¨äºä¿å­˜åŸå§‹é¡ºåº

        // ==================== æ—¶é—´æ’åºåŠŸèƒ½ ====================

        // åˆå§‹åŒ–æ—¶é—´æ’åºåŠŸèƒ½
        function initTimeSort() {
            const timeSortBtn = document.getElementById('timeSortBtn');
            if (timeSortBtn) {
                timeSortBtn.addEventListener('click', toggleTimeSort);
            }
        }

        // åˆ‡æ¢æ—¶é—´æ’åº
        function toggleTimeSort() {
            const timeSortBtn = document.getElementById('timeSortBtn');
            
            if (!isTimeSortActive) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥æœŸæ•°æ®
                const hasDateData = imageData.some(img => img.modifyDate);
                if (!hasDateData) {
                    alert('å½“å‰CSVæ–‡ä»¶æ²¡æœ‰åŒ…å«ä¿®æ”¹æ—¥æœŸä¿¡æ¯ï¼Œæ— æ³•è¿›è¡Œæ—¶é—´æ’åºã€‚');
                    return;
                }
                
                // æ¿€æ´»æ—¶é—´æ’åº
                isTimeSortActive = true;
                timeSortBtn.textContent = 'â° æ—¶é—´æ’åºä¸­ âœ“';
                timeSortBtn.classList.add('active');
                
                // ä¿å­˜åŸå§‹é¡ºåº
                originalImageOrder = [...filteredImages];
                
                // æŒ‰ä¿®æ”¹æ—¥æœŸæ’åºï¼ˆæœ€æ–°åˆ°æœ€ä¹…ï¼‰
                filteredImages.sort((a, b) => {
                    const dateA = a.modifyDate ? new Date(a.modifyDate).getTime() : 0;
                    const dateB = b.modifyDate ? new Date(b.modifyDate).getTime() : 0;
                    return dateB - dateA; // é™åºæ’åˆ—ï¼Œæœ€æ–°åœ¨å‰
                });
                
                // é‡æ–°æ˜¾ç¤ºå›¾ç‰‡
                displayImages();

                
            } else {
                // å–æ¶ˆæ—¶é—´æ’åº
                isTimeSortActive = false;
                timeSortBtn.textContent = 'â° æŒ‰æ—¶é—´æ’åº';
                timeSortBtn.classList.remove('active');
                
                // æ¢å¤åŸå§‹é¡ºåº
                if (originalImageOrder.length > 0) {
                    filteredImages = [...originalImageOrder];
                }
                
                // é‡æ–°æ˜¾ç¤ºå›¾ç‰‡
                displayImages();

            }
        }


        // ==================== ä¿®æ”¹ç°æœ‰å‡½æ•° ====================

        // ä¿®æ”¹ createLazyPlaceholders() å‡½æ•°
        function createLazyPlaceholders() {
            filteredImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card lazy-placeholder';
                card.dataset.index = index;
                card.dataset.loaded = 'false';

                if (image.modifyDate && image.modifyDate instanceof Date) {
                    card.dataset.modifyDate = image.modifyDate.toISOString();
                } else {
                    card.dataset.modifyDate = '';
                }
                
                // æ–°å¢ï¼šå­˜å‚¨ä¿®æ”¹æ—¥æœŸæ•°æ®
                if (image.modifyDate) {
                    card.dataset.modifyDate = image.modifyDate.toISOString();
                } else {
                    card.dataset.modifyDate = '';
                }
                
                // ç®€åŒ–çš„å ä½ç¬¦ç»“æ„
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.style.aspectRatio = '1 / 1';
                placeholder.style.backgroundColor = '#f0f0f0';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.innerHTML = '<div>æ»šåŠ¨åˆ°é™„è¿‘è‡ªåŠ¨åŠ è½½</div>';
                
                card.appendChild(placeholder);
                imageGrid.appendChild(card);

                // ä¿ç•™ç‚¹å‡»äº‹ä»¶ç”¨äºé¢„è§ˆå·²åŠ è½½å›¾ç‰‡
                card.addEventListener('click', () => {
                    if (card.dataset.loaded === 'true') {
                        showPreviewModal(filteredImages[index], index);
                    }
                });
            });
        }

        // ==================== åˆå§‹åŒ–è°ƒç”¨ ====================

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ—¶é—´æ’åºåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(initTimeSort, 100);
        });

        // æˆ–è€…å¦‚æœæ‚¨æœ‰ç°æœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå¯ä»¥åœ¨é‚£é‡Œè°ƒç”¨
        // function initApp() {
        //     // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
        //     initTimeSort();
        // }
        // ==================== åˆ›å»ºæ—¶é—´è½´ ====================
        // åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ ï¼šåˆ›å»ºæ—¶é—´æ˜¾ç¤ºå®¹å™¨
        function createTimeDisplay() {
            // å¦‚æœå·²ç»å­˜åœ¨ï¼Œå…ˆç§»é™¤
            const existing = document.getElementById('firstVisibleTimeDisplay');
            if (existing) existing.remove();
            
            const timeDisplay = document.createElement('div');
            timeDisplay.id = 'firstVisibleTimeDisplay';
            timeDisplay.className = 'time-display-container';
            timeDisplay.innerHTML = `
                <span class="time-display-label">é¦–ä¸ªå¯è§å›¾ç‰‡ä¿®æ”¹æ—¶é—´ï¼š</span>
                <span class="time-display-value">--</span>
            `;
            document.body.appendChild(timeDisplay);
            
            // åˆå§‹éšè—
            timeDisplay.style.display = 'none';
        }

        // æ–°å¢ï¼šé˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è§¦å‘
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ–°å¢ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯è§å›¾ç‰‡å…ƒç´ 
        function findFirstVisibleImage() {
            const cards = document.querySelectorAll('.image-card');
            const container = imageGrid.parentElement;
            const containerRect = container.getBoundingClientRect();
            const containerTop = containerRect.top;
            const containerBottom = containerRect.bottom;
            
            let firstVisibleIndex = -1;
            let minDistance = Infinity;
            
            // éå†æ‰€æœ‰å›¾ç‰‡å¡ç‰‡
            for (const card of cards) {
                const cardRect = card.getBoundingClientRect();
                const cardTop = cardRect.top;
                const cardBottom = cardRect.bottom;
                
                // æ£€æŸ¥å¡ç‰‡æ˜¯å¦åœ¨å®¹å™¨å¯è§èŒƒå›´å†…
                const isPartiallyVisible = (
                    (cardTop >= containerTop && cardTop <= containerBottom) ||    // é¡¶éƒ¨åœ¨èŒƒå›´å†…
                    (cardBottom >= containerTop && cardBottom <= containerBottom) || // åº•éƒ¨åœ¨èŒƒå›´å†…
                    (cardTop < containerTop && cardBottom > containerBottom)      // å¡ç‰‡å®Œå…¨åŒ…å«å®¹å™¨
                );
                
                if (isPartiallyVisible) {
                    // è®¡ç®—å¡ç‰‡é¡¶éƒ¨ä¸å®¹å™¨é¡¶éƒ¨çš„è·ç¦»ï¼ˆç»å¯¹å€¼ï¼‰
                    const distance = Math.abs(cardTop - containerTop);
                    if (distance < minDistance) {
                        minDistance = distance;
                        firstVisibleIndex = parseInt(card.dataset.index);
                    }
                }
            }
            
            return firstVisibleIndex;
        }

        // æ–°å¢ï¼šæ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatDisplayTime(date) {
            if (!date) return 'æ— æ—¶é—´ä¿¡æ¯';
            
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'æ— æ•ˆæ—¶é—´';
                
                // æ ¼å¼åŒ–ä¸ºï¼šYYYY-MM-DD HH:MM:SS
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                const seconds = String(d.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                console.error('æ ¼å¼åŒ–æ—¶é—´å‡ºé”™:', e);
                return 'æ—¶é—´æ ¼å¼åŒ–é”™è¯¯';
            }
        }

        // æ–°å¢ï¼šæ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateFirstVisibleTime() {
            const timeDisplay = document.getElementById('firstVisibleTimeDisplay');
            if (!timeDisplay) return;
            
            const timeValueSpan = timeDisplay.querySelector('.time-display-value');
            if (!timeValueSpan) return;
            
            // å¦‚æœæ—¶é—´æ˜¾ç¤ºæ˜¯éšè—çš„ï¼Œä¸æ›´æ–°å†…å®¹ï¼ˆä½†å¯ä»¥è®¡ç®—ï¼‰
            if (timeDisplay.style.display === 'none' && !timeDisplay.classList.contains('visible')) {
                return;
            }
            
            const firstVisibleIndex = findFirstVisibleImage();
            
            if (firstVisibleIndex >= 0 && firstVisibleIndex < filteredImages.length) {
                const image = filteredImages[firstVisibleIndex];
                if (image.modifyDate && image.modifyDate instanceof Date) {
                    // æ·»åŠ ç´¢å¼•æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
                    const formattedTime = formatDisplayTime(image.modifyDate);
                    timeValueSpan.textContent = `[${firstVisibleIndex + 1}] ${formattedTime}`;
                    timeValueSpan.style.color = '#1890ff';
                    timeValueSpan.title = `å›¾ç‰‡ç´¢å¼•ï¼š${firstVisibleIndex}ï¼Œæ–‡ä»¶ï¼š${image.path.split('\\').pop()}`;
                } else {
                    timeValueSpan.textContent = `[${firstVisibleIndex + 1}] æ— ä¿®æ”¹æ—¶é—´`;
                    timeValueSpan.style.color = '#999';
                    timeValueSpan.title = 'è¯¥å›¾ç‰‡æ²¡æœ‰ä¿®æ”¹æ—¶é—´ä¿¡æ¯';
                }
            } else if (filteredImages.length > 0) {
                timeValueSpan.textContent = 'æ­£åœ¨è®¡ç®—...';
                timeValueSpan.style.color = '#999';
            } else {
                timeValueSpan.textContent = 'æ— å›¾ç‰‡æ•°æ®';
                timeValueSpan.style.color = '#999';
            }
        }

        // ä¿®æ”¹é˜²æŠ–å‡½æ•°å¼•ç”¨
        const debouncedUpdateTime = createScrollDebounce(updateFirstVisibleTime, 80);

        // æ–°å¢ï¼šè®¾ç½®æ»šåŠ¨ç›‘å¬
        function setupScrollTimeDisplay() {
            const container = imageGrid.parentElement; // å›¾ç‰‡å®¹å™¨
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼ˆå¸¦é˜²æŠ–ï¼‰
            container.addEventListener('scroll', debouncedUpdateTime);
            
            // åˆå§‹æ˜¾ç¤ºä¸€æ¬¡
            setTimeout(updateFirstVisibleTime, 100);
        }

        // æ–°å¢ï¼šç§»é™¤æ»šåŠ¨ç›‘å¬ï¼ˆæ¸…ç†æ—¶ä½¿ç”¨ï¼‰
        function removeScrollTimeDisplay() {
            const container = imageGrid.parentElement;
            container.removeEventListener('scroll', debouncedUpdateTime);
        }
        
        // æ–°å¢ï¼šæ»‘æ¡çŠ¶æ€ç®¡ç†
        let scrollTimer = null;
        let isScrollActive = false;
        let hideDelay = 1000; // 1ç§’åéšè—
        let lastScrollTop = 0;

        // æ–°å¢ï¼šæ˜¾ç¤ºæ—¶é—´æ˜¾ç¤º
        function showTimeDisplay(show) {
            const timeDisplay = document.getElementById('firstVisibleTimeDisplay');
            if (!timeDisplay) return;
            
            if (show) {
                timeDisplay.style.display = 'block';
                // ä½¿ç”¨requestAnimationFrameç¡®ä¿æ ·å¼åº”ç”¨
                requestAnimationFrame(() => {
                    timeDisplay.classList.add('visible');
                });
            } else {
                timeDisplay.classList.remove('visible');
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—display
                setTimeout(() => {
                    if (!timeDisplay.classList.contains('visible')) {
                        timeDisplay.style.display = 'none';
                    }
                }, 300);
            }
        }

        // æ–°å¢ï¼šå¤„ç†æ»‘æ¡æ»šåŠ¨
        function handlePreviewScroll() {
            // æ¸…é™¤ä¹‹å‰çš„éšè—è®¡æ—¶å™¨
            clearTimeout(scrollTimer);
            
            // å¦‚æœä¹‹å‰æ˜¯éšè—çŠ¶æ€ï¼Œæ˜¾ç¤ºæ—¶é—´æ˜¾ç¤º
            if (!isScrollActive) {
                isScrollActive = true;
                showTimeDisplay(true);
            }
            
            // æ›´æ–°å½“å‰æ—¶é—´ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
            debouncedUpdateTime();
            
            // è®¾ç½®éšè—è®¡æ—¶å™¨
            scrollTimer = setTimeout(() => {
                isScrollActive = false;
                showTimeDisplay(false);
            }, hideDelay);
        }

        // æ–°å¢ï¼šæ”¹è¿›çš„é˜²æŠ–å‡½æ•°ï¼ˆä¸“ç”¨äºæ»šåŠ¨ï¼‰
        function createScrollDebounce(func, wait) {
            let timeout;
            let lastCall = 0;
            return function() {
                const context = this;
                const args = arguments;
                const now = Date.now();
                
                // å¦‚æœè·ç¦»ä¸Šæ¬¡è°ƒç”¨æ—¶é—´å¾ˆçŸ­ï¼Œåˆ™å»¶è¿Ÿæ‰§è¡Œ
                if (now - lastCall < wait) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        lastCall = now;
                        func.apply(context, args);
                    }, wait);
                } else {
                    // å¦åˆ™ç«‹å³æ‰§è¡Œ
                    lastCall = now;
                    func.apply(context, args);
                }
            };
        }

        // åˆ›å»ºä¸“ç”¨çš„æ»šåŠ¨é˜²æŠ–å‡½æ•°
        const scrollDebouncedUpdate = createScrollDebounce(updateFirstVisibleTime, 80);

        function setupPreviewScrollListener() {
            const previewSection = document.querySelector('.preview-section');
            
            if (!previewSection) {
                console.warn('æœªæ‰¾åˆ°.preview-sectionå…ƒç´ ');
                return;
            }
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            previewSection.addEventListener('scroll', function() {
                handlePreviewScroll();
            });
            
            // ç›‘å¬é¼ æ ‡æŒ‰ä¸‹ï¼ˆå¼€å§‹æ‹–åŠ¨ï¼‰
            previewSection.addEventListener('mousedown', function() {
                isScrollActive = true;
                showTimeDisplay(true);
            });
            
            // ç›‘å¬é¼ æ ‡æ¾å¼€ï¼ˆç»“æŸæ‹–åŠ¨ï¼‰
            previewSection.addEventListener('mouseup', function() {
                // ä¸ç«‹å³éšè—ï¼Œé€šè¿‡è®¡æ—¶å™¨æ§åˆ¶
            });
            
            // ç›‘å¬æ»šè½®äº‹ä»¶ï¼ˆé€‚ç”¨äºæ²¡æœ‰æ»šåŠ¨æ¡ä½†ä½¿ç”¨æ»šè½®çš„æƒ…å†µï¼‰
            previewSection.addEventListener('wheel', function() {
                handlePreviewScroll();
            });
            
            console.log('é¢„è§ˆåŒºæ»‘æ¡ç›‘å¬å·²è®¾ç½®');
        }



    </script>
</body>
</html>
